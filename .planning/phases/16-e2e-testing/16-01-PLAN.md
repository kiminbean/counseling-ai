---
phase: 16-e2e-testing
plan: 01
type: execute
depends_on: []
files_modified: [package.json, playwright.config.ts, e2e/chat.spec.ts, e2e/auth.spec.ts, e2e/navigation.spec.ts, e2e/pwa.spec.ts, .github/workflows/e2e.yml]
---

<objective>
Playwright E2E 테스트 설정 및 핵심 시나리오 자동화

Purpose: 핵심 사용자 플로우를 자동화하여 배포 전 회귀 테스트 가능하게 함
Output: Playwright 설정, 4개 테스트 스위트 (채팅, 인증, 네비게이션, PWA)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Research topics:** Playwright Next.js 설정
**Key files:**
@package.json
@app/page.tsx
@app/layout.tsx
@lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Playwright</name>
  <files>package.json, playwright.config.ts</files>
  <action>
  1. Install Playwright:
     ```bash
     npm install -D @playwright/test
     npx playwright install chromium
     ```

  2. Create playwright.config.ts:
     ```typescript
     import { defineConfig, devices } from '@playwright/test';

     export default defineConfig({
       testDir: './e2e',
       fullyParallel: true,
       forbidOnly: !!process.env.CI,
       retries: process.env.CI ? 2 : 0,
       workers: process.env.CI ? 1 : undefined,
       reporter: 'html',
       use: {
         baseURL: 'http://localhost:3000',
         trace: 'on-first-retry',
         screenshot: 'only-on-failure',
       },
       projects: [
         {
           name: 'chromium',
           use: { ...devices['Desktop Chrome'] },
         },
         {
           name: 'Mobile Chrome',
           use: { ...devices['Pixel 5'] },
         },
       ],
       webServer: {
         command: 'npm run dev',
         url: 'http://localhost:3000',
         reuseExistingServer: !process.env.CI,
         timeout: 120 * 1000,
       },
     });
     ```

  3. Add npm scripts to package.json:
     ```json
     "scripts": {
       "test:e2e": "playwright test",
       "test:e2e:ui": "playwright test --ui",
       "test:e2e:report": "playwright show-report"
     }
     ```

  4. Create e2e/ directory for test files
  </action>
  <verify>npx playwright test --version succeeds</verify>
  <done>Playwright installed, config created, npm scripts added</done>
</task>

<task type="auto">
  <name>Task 2: Create authentication flow tests</name>
  <files>e2e/auth.spec.ts</files>
  <action>
  Create e2e/auth.spec.ts with tests:

  1. **Anonymous authentication**:
     - Visit home page
     - Wait for auth to complete
     - Verify localStorage has access_token and user_id
     - Verify no auth error displayed

  2. **Session persistence**:
     - Visit home page and wait for auth
     - Reload page
     - Verify same user_id persists

  3. **Token refresh** (if applicable):
     - Manipulate token expiry
     - Verify refresh occurs

  ```typescript
  import { test, expect } from '@playwright/test';

  test.describe('Authentication Flow', () => {
    test('should authenticate anonymously on first visit', async ({ page }) => {
      await page.goto('/');

      // Wait for auth to complete
      await page.waitForFunction(() => {
        return localStorage.getItem('access_token') !== null;
      });

      const token = await page.evaluate(() => localStorage.getItem('access_token'));
      const userId = await page.evaluate(() => localStorage.getItem('user_id'));

      expect(token).toBeTruthy();
      expect(userId).toBeTruthy();
    });

    test('should persist session across page reloads', async ({ page }) => {
      await page.goto('/');
      await page.waitForFunction(() => localStorage.getItem('user_id'));

      const userId1 = await page.evaluate(() => localStorage.getItem('user_id'));

      await page.reload();
      await page.waitForFunction(() => localStorage.getItem('user_id'));

      const userId2 = await page.evaluate(() => localStorage.getItem('user_id'));

      expect(userId1).toBe(userId2);
    });
  });
  ```
  </action>
  <verify>npm run test:e2e -- --grep "Authentication"</verify>
  <done>Authentication flow tests created and passing</done>
</task>

<task type="auto">
  <name>Task 3: Create chat flow tests</name>
  <files>e2e/chat.spec.ts</files>
  <action>
  Create e2e/chat.spec.ts with tests:

  1. **Send message**:
     - Type message in input
     - Click send or press Enter
     - Verify user message appears
     - Verify AI response appears (mock or real)

  2. **Message persistence**:
     - Send a message
     - Reload page
     - Verify message history restored from localStorage

  3. **Loading states**:
     - Verify loading indicator appears during API call

  4. **Error handling**:
     - Mock API failure
     - Verify error toast appears

  ```typescript
  import { test, expect } from '@playwright/test';

  test.describe('Chat Flow', () => {
    test.beforeEach(async ({ page }) => {
      await page.goto('/');
      // Wait for auth and initial load
      await page.waitForFunction(() => localStorage.getItem('access_token'));
    });

    test('should send message and receive response', async ({ page }) => {
      const input = page.getByRole('textbox', { name: /메시지/i });
      await input.fill('안녕하세요');
      await input.press('Enter');

      // Verify user message appears
      await expect(page.getByText('안녕하세요').first()).toBeVisible();

      // Wait for AI response (with timeout for API)
      await expect(page.locator('[data-testid="ai-message"]').first())
        .toBeVisible({ timeout: 30000 });
    });

    test('should persist messages after reload', async ({ page }) => {
      const input = page.getByRole('textbox', { name: /메시지/i });
      await input.fill('테스트 메시지');
      await input.press('Enter');

      await expect(page.getByText('테스트 메시지')).toBeVisible();

      await page.reload();

      // Messages should be restored
      await expect(page.getByText('테스트 메시지')).toBeVisible();
    });
  });
  ```
  </action>
  <verify>npm run test:e2e -- --grep "Chat"</verify>
  <done>Chat flow tests created and passing</done>
</task>

<task type="auto">
  <name>Task 4: Create navigation and page tests</name>
  <files>e2e/navigation.spec.ts</files>
  <action>
  Create e2e/navigation.spec.ts with tests:

  1. **Bottom navigation (mobile)**:
     - Set mobile viewport
     - Verify all nav items visible
     - Click each nav item, verify route change

  2. **Settings page**:
     - Navigate to /settings
     - Verify all sections visible (테마, 알림, 개인정보, 앱 정보)
     - Toggle dark mode, verify theme changes

  3. **Help page**:
     - Navigate to /help
     - Verify FAQ accordion works
     - Verify contact info visible

  4. **Privacy page**:
     - Navigate to /privacy
     - Verify all sections visible

  ```typescript
  import { test, expect } from '@playwright/test';

  test.describe('Navigation', () => {
    test('should navigate via bottom nav on mobile', async ({ page }) => {
      await page.setViewportSize({ width: 390, height: 844 });
      await page.goto('/');

      const bottomNav = page.locator('nav').filter({ hasText: /상담|기분|운동|프로필/ });
      await expect(bottomNav).toBeVisible();

      // Navigate to profile
      await page.getByRole('link', { name: /프로필/i }).click();
      await expect(page).toHaveURL('/profile');
    });

    test('settings page should display all sections', async ({ page }) => {
      await page.goto('/settings');

      await expect(page.getByText('테마 설정')).toBeVisible();
      await expect(page.getByText('알림 설정')).toBeVisible();
      await expect(page.getByText('개인정보 관리')).toBeVisible();
      await expect(page.getByText('앱 정보')).toBeVisible();
    });

    test('should toggle dark mode in settings', async ({ page }) => {
      await page.goto('/settings');

      // Click dark mode button
      await page.getByRole('button', { name: /다크/i }).click();

      // Verify dark class applied to html
      await expect(page.locator('html')).toHaveClass(/dark/);
    });

    test('help page FAQ accordion should work', async ({ page }) => {
      await page.goto('/help');

      const faqItem = page.getByText('대화 내용은 안전한가요?');
      await faqItem.click();

      // Verify answer is visible
      await expect(page.getByText(/암호화/)).toBeVisible();
    });
  });
  ```
  </action>
  <verify>npm run test:e2e -- --grep "Navigation"</verify>
  <done>Navigation and page tests created and passing</done>
</task>

<task type="auto">
  <name>Task 5: Create PWA and offline tests</name>
  <files>e2e/pwa.spec.ts</files>
  <action>
  Create e2e/pwa.spec.ts with tests:

  1. **Service Worker registration**:
     - Visit page
     - Verify service worker is registered

  2. **Manifest accessibility**:
     - Fetch /manifest.json
     - Verify correct structure and icons

  3. **Offline indicator**:
     - Go offline (network emulation)
     - Verify offline banner/indicator appears

  ```typescript
  import { test, expect } from '@playwright/test';

  test.describe('PWA Features', () => {
    test('should register service worker', async ({ page }) => {
      await page.goto('/');

      // Wait for SW registration
      const swRegistered = await page.evaluate(async () => {
        if (!('serviceWorker' in navigator)) return false;
        const registration = await navigator.serviceWorker.getRegistration();
        return !!registration;
      });

      expect(swRegistered).toBe(true);
    });

    test('manifest.json should be accessible and valid', async ({ page }) => {
      const response = await page.goto('/manifest.json');
      expect(response?.status()).toBe(200);

      const manifest = await response?.json();
      expect(manifest.name).toBe('마음다리');
      expect(manifest.icons).toHaveLength(8);
    });

    test('should show offline indicator when offline', async ({ page, context }) => {
      await page.goto('/');
      await page.waitForLoadState('networkidle');

      // Go offline
      await context.setOffline(true);

      // Trigger offline detection (may need to wait or click something)
      await page.waitForTimeout(1000);

      // Check for offline indicator
      const offlineIndicator = page.getByText(/오프라인/i);
      await expect(offlineIndicator).toBeVisible({ timeout: 5000 });

      // Go back online
      await context.setOffline(false);
    });
  });
  ```
  </action>
  <verify>npm run test:e2e -- --grep "PWA"</verify>
  <done>PWA and offline tests created and passing</done>
</task>

<task type="auto">
  <name>Task 6: Create CI workflow for E2E tests</name>
  <files>.github/workflows/e2e.yml</files>
  <action>
  Create .github/workflows/e2e.yml:

  ```yaml
  name: E2E Tests

  on:
    push:
      branches: [main, develop]
    pull_request:
      branches: [main]

  jobs:
    e2e:
      timeout-minutes: 20
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20'
            cache: 'npm'
            cache-dependency-path: frontend/package-lock.json

        - name: Install dependencies
          working-directory: frontend
          run: npm ci

        - name: Install Playwright Browsers
          working-directory: frontend
          run: npx playwright install --with-deps chromium

        - name: Run E2E tests
          working-directory: frontend
          run: npm run test:e2e
          env:
            NEXT_PUBLIC_API_URL: ${{ secrets.API_URL }}

        - name: Upload test results
          uses: actions/upload-artifact@v4
          if: always()
          with:
            name: playwright-report
            path: frontend/playwright-report/
            retention-days: 30
  ```
  </action>
  <verify>YAML syntax is valid</verify>
  <done>CI workflow for E2E tests created</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:e2e` succeeds without errors
- [ ] All 4 test suites pass (auth, chat, navigation, pwa)
- [ ] Tests work in both desktop and mobile viewports
- [ ] playwright.config.ts properly configured
- [ ] CI workflow YAML is valid
- [ ] Phase 16 complete
</verification>

<success_criteria>
- Playwright installed and configured
- 4 E2E test suites covering core flows
- Tests pass locally
- CI workflow ready for GitHub Actions
- All v2.0 milestone phases complete
</success_criteria>

<output>
After completion, create `.planning/phases/16-e2e-testing/16-01-SUMMARY.md`
</output>
