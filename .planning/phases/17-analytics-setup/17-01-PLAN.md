---
phase: 17-analytics-setup
plan: 01
type: execute
depends_on: []
files_modified: [lib/analytics.ts, app/layout.tsx, components/providers/Providers.tsx, lib/constants.ts]
---

<objective>
Google Analytics 4 연동 및 이벤트 트래킹 구현

Purpose: 사용자 행동 분석을 위한 GA4 통합으로 서비스 개선 데이터 수집
Output: GA4 스크립트 로딩, 페이지뷰/이벤트 트래킹 유틸리티, 개인정보 고려 구현
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/monitoring.ts

**Tech stack:** Next.js 14 App Router, TypeScript
**Established patterns:** lib/ 유틸리티 패턴, Providers 컴포넌트 래핑
**Constraining decisions:**
- 기존 monitoring.ts 패턴 따르기 (동적 로드, 환경 변수 기반 활성화)
- 개인정보 보호 고려 (익명화, 동의 기반)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics utility module</name>
  <files>lib/analytics.ts</files>
  <action>
GA4 분석 유틸리티 생성:
- NEXT_PUBLIC_GA_MEASUREMENT_ID 환경 변수로 활성화 제어
- gtag 스크립트 동적 로드 함수
- pageview(url) 함수: 페이지뷰 트래킹
- event(action, category, label?, value?) 함수: 이벤트 트래킹
- setUserProperties(properties) 함수: 익명 사용자 속성 설정
- 심리상담 앱 특성 고려: 민감한 개인정보 전송 금지 (메시지 내용, 감정 원시값 등)
- monitoring.ts 패턴 따르기: isDevelopment 시 콘솔 로깅

주의: window.gtag 타입 정의 포함, SSR 환경에서 window 접근 주의
  </action>
  <verify>TypeScript 컴파일 오류 없음: npx tsc --noEmit</verify>
  <done>analytics.ts 생성됨, gtag 함수 타입 정의됨, pageview/event 함수 내보내기 완료</done>
</task>

<task type="auto">
  <name>Task 2: Add GA4 script to layout</name>
  <files>app/layout.tsx, components/providers/Providers.tsx</files>
  <action>
layout.tsx 또는 Providers에 GA4 스크립트 추가:
- next/script 사용 (strategy="afterInteractive")
- NEXT_PUBLIC_GA_MEASUREMENT_ID 환경 변수로 조건부 렌더링
- 페이지 라우트 변경 시 pageview 호출 (usePathname + useEffect)

AnalyticsProvider 컴포넌트 생성 고려:
- 라우트 변경 감지 후 pageview 호출
- Providers.tsx에 추가
  </action>
  <verify>개발 서버에서 GA 스크립트 로드 확인 (NEXT_PUBLIC_GA_MEASUREMENT_ID 설정 시)</verify>
  <done>GA4 스크립트 조건부 로드, 페이지뷰 자동 트래킹 동작</done>
</task>

<task type="auto">
  <name>Task 3: Add analytics constants and events</name>
  <files>lib/constants.ts, lib/analytics.ts</files>
  <action>
분석 이벤트 상수 추가:
- ANALYTICS_EVENTS 객체: chat_message_sent, mood_checkin_completed, exercise_started, crisis_hotline_shown 등
- 각 이벤트에 카테고리/액션 정의

핵심 이벤트 트래킹 포인트 문서화:
- 채팅 메시지 전송 (빈도만, 내용 제외)
- 기분 체크인 완료
- 운동 시작/완료
- 위기 핫라인 표시 (중요 안전 메트릭)

주의: 개인정보 포함 금지 (메시지 텍스트, 구체적 감정 상태 등)
  </action>
  <verify>constants.ts 업데이트 확인</verify>
  <done>ANALYTICS_EVENTS 상수 정의됨, 이벤트 명명 규칙 확립</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` 오류 없음
- [ ] TypeScript 오류 없음
- [ ] GA_MEASUREMENT_ID 없을 때도 빌드 성공
- [ ] 개발 환경에서 콘솔에 pageview 로그 출력
</verification>

<success_criteria>
- lib/analytics.ts 생성됨
- GA4 스크립트 조건부 로드 동작
- pageview, event 함수 내보내기
- ANALYTICS_EVENTS 상수 정의됨
- 개인정보 전송하지 않는 안전한 구현
</success_criteria>

<output>
After completion, create `.planning/phases/17-analytics-setup/17-01-SUMMARY.md`
</output>
