---
phase: 20-push-backend
plan: 01
type: execute
depends_on: []
files_modified: [lib/pushNotifications.ts, lib/api.ts, hooks/usePushNotifications.ts]
---

<objective>
FCM (Firebase Cloud Messaging) 클라이언트 연동 및 토큰 관리

Purpose: 웹 푸시 알림을 위한 FCM 토큰 획득 및 서버 전송 준비
Output: FCM SDK 설정, 알림 권한 요청, 토큰 관리 유틸리티
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@public/sw.js
@lib/api.ts

**Tech stack:** Next.js 14 App Router, TypeScript
**Prior work:**
- Phase 11에서 Service Worker (sw.js) 구현됨
- 기존 API 패턴 (lib/api.ts)
**Constraining decisions:**
- Firebase SDK v9+ (modular) 사용
- 기존 Service Worker 확장
- 백엔드 API 엔드포인트 필요 (현재 미구현, 토큰 저장 로직만 준비)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Firebase SDK</name>
  <files>package.json</files>
  <action>
Firebase SDK 설치:
npm install firebase

Firebase 모듈식 SDK v9+ 사용 (트리 쉐이킹 지원)
필요한 모듈만 import: firebase/app, firebase/messaging
  </action>
  <verify>npm ls firebase</verify>
  <done>firebase 패키지 설치됨</done>
</task>

<task type="auto">
  <name>Task 2: Create push notifications utility</name>
  <files>lib/pushNotifications.ts</files>
  <action>
푸시 알림 유틸리티 생성:

1. Firebase 초기화:
- NEXT_PUBLIC_FIREBASE_* 환경 변수로 설정
- 환경 변수 없으면 비활성화

2. 함수 구현:
- initializeFirebaseMessaging(): Firebase Messaging 초기화
- requestNotificationPermission(): 알림 권한 요청
- getFCMToken(): FCM 토큰 획득
- onMessageReceived(callback): 포그라운드 메시지 수신 핸들러
- saveFCMTokenToServer(token): 서버에 토큰 저장 (API 호출)

3. 토큰 관리:
- localStorage에 토큰 캐시 (변경 감지용)
- 토큰 갱신 시 서버에 업데이트

주의:
- SSR 환경에서 window/navigator 접근 주의
- 알림 권한 거부 처리
- Firebase 설정 없을 때 graceful 비활성화

Firebase 설정 예시:
```typescript
const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
};
```
  </action>
  <verify>TypeScript 컴파일 오류 없음</verify>
  <done>pushNotifications.ts 생성됨, FCM 초기화/토큰 함수 정의됨</done>
</task>

<task type="auto">
  <name>Task 3: Create usePushNotifications hook</name>
  <files>hooks/usePushNotifications.ts, hooks/index.ts</files>
  <action>
React Hook 생성:

usePushNotifications() 훅:
- isSupported: 브라우저 지원 여부
- permission: 현재 권한 상태 ('default' | 'granted' | 'denied')
- token: FCM 토큰 (획득 시)
- isLoading: 초기화 중
- error: 에러 상태
- requestPermission(): 권한 요청 함수

구현:
```typescript
export function usePushNotifications() {
  const [permission, setPermission] = useState<NotificationPermission>('default');
  const [token, setToken] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  const isSupported = typeof window !== 'undefined' &&
    'Notification' in window &&
    'serviceWorker' in navigator;

  // ... 초기화 및 권한 요청 로직

  return { isSupported, permission, token, isLoading, error, requestPermission };
}
```

hooks/index.ts에 export 추가
  </action>
  <verify>TypeScript 컴파일 오류 없음</verify>
  <done>usePushNotifications 훅 생성됨, hooks/index.ts에 export됨</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` 오류 없음
- [ ] Firebase 환경 변수 없이도 빌드 성공
- [ ] TypeScript 타입 오류 없음
- [ ] 브라우저에서 알림 권한 요청 테스트 가능
</verification>

<success_criteria>
- firebase 패키지 설치됨
- lib/pushNotifications.ts 생성됨
- usePushNotifications 훅 생성됨
- Firebase 설정 없을 때 graceful 비활성화
- 알림 권한 요청 동작
</success_criteria>

<output>
After completion, create `.planning/phases/20-push-backend/20-01-SUMMARY.md`
</output>
