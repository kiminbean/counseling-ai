---
phase: 21-push-frontend
plan: 01
type: execute
depends_on: ["20-01"]
files_modified: [public/firebase-messaging-sw.js, app/settings/page.tsx, components/common/PushNotificationButton.tsx]
---

<objective>
Service Worker 푸시 핸들링 및 알림 설정 UI 구현

Purpose: 백그라운드 푸시 알림 수신 및 사용자 친화적 알림 설정 인터페이스
Output: Firebase Messaging Service Worker, 알림 설정 UI 컴포넌트
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-push-backend/20-01-SUMMARY.md
@public/sw.js
@app/settings/page.tsx
@hooks/usePushNotifications.ts

**Tech stack:** Next.js 14 App Router, TypeScript
**Prior work:**
- Phase 20에서 Firebase SDK 설치, pushNotifications.ts, usePushNotifications 훅 구현
- 기존 sw.js Service Worker
- 설정 페이지 (/settings) 존재
**Constraining decisions:**
- Firebase Messaging용 별도 Service Worker 필요
- 기존 설정 페이지의 알림 섹션 확장
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Firebase Messaging Service Worker</name>
  <files>public/firebase-messaging-sw.js</files>
  <action>
Firebase Messaging Service Worker 생성:

이 파일은 Firebase에서 요구하는 특정 이름과 위치에 있어야 합니다.
백그라운드 푸시 알림을 처리합니다.

내용:
```javascript
// Firebase compat SDK 사용 (Service Worker에서 필요)
importScripts('https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js');

// Firebase 설정 (환경 변수 사용 불가, 하드코딩 또는 동적 로드)
// 프로덕션에서는 서버에서 설정을 가져오거나, 빌드 시 주입
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID",
});

const messaging = firebase.messaging();

// 백그라운드 메시지 핸들러
messaging.onBackgroundMessage((payload) => {
  console.log('[firebase-messaging-sw] Background message:', payload);

  const notificationTitle = payload.notification?.title || 'MindBridge AI';
  const notificationOptions = {
    body: payload.notification?.body || '새로운 메시지가 있습니다.',
    icon: '/icons/icon-192x192.png',
    badge: '/icons/icon-72x72.png',
    tag: payload.data?.tag || 'default',
    data: payload.data,
  };

  self.registration.showNotification(notificationTitle, notificationOptions);
});

// 알림 클릭 핸들러
self.addEventListener('notificationclick', (event) => {
  event.notification.close();

  const urlToOpen = event.notification.data?.url || '/';

  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true })
      .then((windowClients) => {
        for (const client of windowClients) {
          if (client.url === urlToOpen && 'focus' in client) {
            return client.focus();
          }
        }
        return clients.openWindow(urlToOpen);
      })
  );
});
```

주의:
- Firebase 설정은 placeholder로 두고, 실제 사용 시 교체 필요
- 또는 빌드 스크립트로 환경 변수 주입
  </action>
  <verify>Service Worker 문법 오류 없음</verify>
  <done>firebase-messaging-sw.js 생성됨, 백그라운드 메시지 핸들러 구현됨</done>
</task>

<task type="auto">
  <name>Task 2: Create PushNotificationButton component</name>
  <files>components/common/PushNotificationButton.tsx</files>
  <action>
푸시 알림 활성화 버튼 컴포넌트 생성:

'use client' 컴포넌트로 구현:
- usePushNotifications 훅 사용
- 브라우저 미지원 시 숨김
- 권한 상태에 따른 UI:
  - default: "알림 켜기" 버튼
  - granted: "알림 켜짐" (체크 아이콘)
  - denied: "알림 차단됨" (설정 안내)
- 로딩 상태 표시
- 에러 처리

UI 구조:
```tsx
export function PushNotificationButton() {
  const { isSupported, permission, isLoading, requestPermission } = usePushNotifications();

  if (!isSupported) return null;

  return (
    <button
      onClick={requestPermission}
      disabled={permission !== 'default' || isLoading}
      className="..."
    >
      {permission === 'granted' && <Check />}
      {permission === 'denied' && <BellOff />}
      {permission === 'default' && <Bell />}
      {/* 상태별 텍스트 */}
    </button>
  );
}
```
  </action>
  <verify>TypeScript 컴파일 오류 없음</verify>
  <done>PushNotificationButton 컴포넌트 생성됨</done>
</task>

<task type="auto">
  <name>Task 3: Integrate push notification UI in settings</name>
  <files>app/settings/page.tsx</files>
  <action>
설정 페이지의 알림 섹션 업데이트:

기존 알림 토글 대신 또는 추가로 PushNotificationButton 통합:
- "푸시 알림" 설정 항목 추가
- PushNotificationButton 컴포넌트 사용
- 권한 상태 설명 텍스트 추가
- 권한 거부 시 브라우저 설정 안내

구조:
```tsx
{/* 알림 설정 섹션 */}
<section>
  <h2>알림 설정</h2>

  {/* 기존 인앱 알림 토글 */}
  <div>
    <span>인앱 알림</span>
    <Toggle ... />
  </div>

  {/* 새로운 푸시 알림 설정 */}
  <div>
    <span>푸시 알림</span>
    <PushNotificationButton />
    <p className="text-sm text-gray-500">
      {permission === 'denied' && '브라우저 설정에서 알림을 허용해주세요.'}
    </p>
  </div>
</section>
```
  </action>
  <verify>설정 페이지에서 푸시 알림 UI 확인</verify>
  <done>설정 페이지에 푸시 알림 UI 통합됨</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` 오류 없음
- [ ] firebase-messaging-sw.js 존재
- [ ] 설정 페이지에서 푸시 알림 UI 표시
- [ ] 알림 권한 요청 동작 (Firebase 설정 시)
- [ ] E2E 테스트 통과 (기존 테스트)
</verification>

<success_criteria>
- firebase-messaging-sw.js 생성됨
- PushNotificationButton 컴포넌트 생성됨
- 설정 페이지에 푸시 알림 UI 통합됨
- 백그라운드 알림 수신 준비 완료
- Phase 21 complete, v2.1 milestone ready for testing
</success_criteria>

<output>
After completion, create `.planning/phases/21-push-frontend/21-01-SUMMARY.md`
</output>
