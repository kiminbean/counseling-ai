<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counseling AI - Mind Bridge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        .chat-container { height: calc(100vh - 180px); }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-hidden">

    <!-- Header -->
    <header class="h-16 border-b glass fixed top-0 w-full z-10 flex items-center justify-between px-6">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 p-2 rounded-lg">
                <i data-lucide="heart" class="text-white w-5 h-5"></i>
            </div>
            <h1 class="text-xl font-bold tracking-tight text-indigo-900">Mind Bridge AI</h1>
            <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded-full font-medium">v3.0.0</span>
        </div>
        <div class="flex items-center gap-4">
            <select id="langSelect" class="bg-transparent text-sm font-medium focus:outline-none cursor-pointer">
                <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
            </select>
            <button class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                <i data-lucide="settings" class="w-5 h-5 text-slate-500"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="mt-16 flex flex-col md:flex-row h-screen">
        
        <!-- Sidebar (Desktop) -->
        <aside class="hidden md:flex w-72 border-r bg-white flex-col">
            <div class="p-4 flex-1 overflow-y-auto">
                <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-4">í˜„ì¬ ì„¸ì…˜ ë¶„ì„</h2>
                <div id="analysis" class="space-y-4">
                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                        <p class="text-xs text-slate-500 mb-1">ê°ì§€ëœ ê°ì •</p>
                        <div class="flex items-center gap-2">
                            <span id="emotionIcon" class="text-2xl">ğŸ˜¶</span>
                            <span id="emotionText" class="font-bold text-slate-700">ëŒ€ê¸° ì¤‘</span>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                        <p class="text-xs text-slate-500 mb-1">ê³µê°ë„ ìŠ¤ì½”ì–´</p>
                        <div class="w-full bg-slate-200 h-2 rounded-full mt-2">
                            <div id="empathyBar" class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center">
                        <i data-lucide="user" class="text-indigo-600 w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="text-sm font-bold">ìµëª… ì‚¬ìš©ì</p>
                        <p class="text-xs text-green-500 flex items-center gap-1">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> Online
                        </p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Chat Area -->
        <section class="flex-1 flex flex-col glass">
            <!-- Messages -->
            <div id="chatBox" class="chat-container flex-1 overflow-y-auto p-6 space-y-6">
                <!-- AI Welcome Message -->
                <div class="flex gap-3 max-w-2xl">
                    <div class="w-8 h-8 rounded-lg bg-indigo-600 flex-shrink-0 flex items-center justify-center mt-1">
                        <i data-lucide="bot" class="text-white w-5 h-5"></i>
                    </div>
                    <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100">
                        <p class="text-sm leading-relaxed">ì•ˆë…•í•˜ì„¸ìš”. ì €ëŠ” ë‹¹ì‹ ì˜ ë§ˆìŒì„ ë“¤ì–´ë“œë¦¬ëŠ” Mind Bridge AIì…ë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë– ì…¨ë‚˜ìš”? ì–´ë–¤ ì´ì•¼ê¸°ë“  í¸í•˜ê²Œ ë§ì”€í•´ ì£¼ì„¸ìš”.</p>
                        <span class="text-[10px] text-slate-400 mt-2 block">AI ìƒë‹´ì‚¬ â€¢ ë°©ê¸ˆ ì „</span>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t glass bg-white/50">
                <form id="chatForm" class="max-w-4xl mx-auto flex items-end gap-2 relative">
                    <div class="flex-1 relative">
                        <textarea 
                            id="messageInput"
                            rows="1"
                            placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                            class="w-full bg-white border border-slate-200 rounded-2xl px-4 py-3 pr-12 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none shadow-sm transition-all"
                        ></textarea>
                        <button type="button" class="absolute right-3 bottom-3 text-slate-400 hover:text-indigo-600">
                            <i data-lucide="mic" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <button 
                        type="submit" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-2xl shadow-lg shadow-indigo-200 transition-all active:scale-95"
                    >
                        <i data-lucide="send" class="w-6 h-6"></i>
                    </button>
                </form>
                <p class="text-center text-[10px] text-slate-400 mt-2 italic">ìœ„ê¸° ìƒí™© ì‹œ 1393(ìì‚´ì˜ˆë°©) ë˜ëŠ” 1577-0199(ì •ì‹ ê±´ê°•ìƒë‹´)ì— ì—°ë½í•˜ì„¸ìš”.</p>
            </div>
        </section>
    </main>

    <script>
        // Lucide ì•„ì´ì½˜ ì´ˆê¸°í™”
        lucide.createIcons();

        const chatBox = document.getElementById('chatBox');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const langSelect = document.getElementById('langSelect');

        // ìë™ ì¤„ë°”ê¿ˆ
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function addMessage(role, text, emotion = null) {
            const wrapper = document.createElement('div');
            wrapper.className = role === 'user' ? 'flex justify-end' : 'flex gap-3 max-w-2xl';
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            if (role === 'user') {
                wrapper.innerHTML = `
                    <div class="flex flex-col items-end max-w-[80%]">
                        <div class="bg-indigo-600 text-white p-4 rounded-2xl rounded-tr-none shadow-md">
                            <p class="text-sm leading-relaxed">${text}</p>
                        </div>
                        <span class="text-[10px] text-slate-400 mt-1">${time}</span>
                    </div>
                `;
            } else {
                wrapper.innerHTML = `
                    <div class="w-8 h-8 rounded-lg bg-indigo-600 flex-shrink-0 flex items-center justify-center mt-1">
                        <i data-lucide="bot" class="text-white w-5 h-5"></i>
                    </div>
                    <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100">
                        <p class="text-sm leading-relaxed">${text}</p>
                        <span class="text-[10px] text-slate-400 mt-2 block">AI ìƒë‹´ì‚¬ â€¢ ${time}</span>
                    </div>
                `;
            }
            
            chatBox.appendChild(wrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
            lucide.createIcons();
        }

        // í¼ ì œì¶œ í•¸ë“¤ëŸ¬ (API ì—°ë™)
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addMessage('user', message);
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // ë¡œë”© í‘œì‹œ (ì„ì‹œ)
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'text-[10px] text-slate-400 animate-pulse';
            loadingDiv.innerText = 'AIê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤...';
            chatBox.appendChild(loadingDiv);

            try {
                // API í˜¸ì¶œ (Phase 3 Endpoint)
                const response = await fetch('/api/v3/chat/multilingual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'secret_token'
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: "web_session_001",
                        language: langSelect.value,
                        enable_personalization: true
                    })
                });

                const data = await response.json();
                chatBox.removeChild(loadingDiv);

                // AI ë©”ì‹œì§€ ì¶”ê°€
                addMessage('ai', data.response_text);

                // ë¶„ì„ ì—…ë°ì´íŠ¸
                if (data.emotion_analysis) {
                    const emo = data.emotion_analysis.primary_emotion;
                    document.getElementById('emotionText').innerText = emo;
                    document.getElementById('empathyBar').style.width = (data.supervisor_feedback.quality_score * 100) + '%';
                    
                    const icons = { 'sadness': 'ğŸ˜¢', 'happiness': 'ğŸ˜Š', 'anger': 'ğŸ˜¡', 'anxiety': 'ğŸ˜°', 'neutral': 'ğŸ˜' };
                    document.getElementById('emotionIcon').innerText = icons[emo] || 'ğŸ˜¶';
                }

            } catch (error) {
                console.error('Error:', error);
                chatBox.removeChild(loadingDiv);
                addMessage('ai', 'ì£„ì†¡í•©ë‹ˆë‹¤. ì„œë²„ì™€ ì—°ê²°í•˜ëŠ” ì¤‘ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    </script>
</body>
</html>
